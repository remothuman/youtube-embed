{
  "name": "Video Tools Feature Set",
  "version": "3.0.0",
  "status": "draft",
  "overview": {
    "description": "Add tasteful extra features behind a minimal 'Video Tools' dropdown. Features enhance video watching without cluttering the minimal interface. Progressive disclosure: users who don't want features don't see them.",
    "principles": [
      "Minimal by default - all tools in dropdown, none active initially (except SponsorBlock)",
      "SponsorBlock enabled by default in manual mode (shows skip button overlay)",
      "Active tools shown at top level for quick access",
      "Active tools reset on video navigation, settings persist in localStorage",
      "URL params for shareable tool state (silence only - sponsors is default on)",
      "Graceful degradation - if a service is down, player still works",
      "Vertical slicing - each feature built end-to-end before starting next"
    ]
  },
  "implementation_phases": [
    {
      "phase": -1,
      "name": "Svelte 5 Upgrade",
      "description": "Prerequisite for modern reactivity patterns ($state, $effect, $derived)",
      "features": ["svelte5-upgrade"]
    },
    {
      "phase": 0,
      "name": "YouTube IFrame Player API",
      "description": "Foundation for all skip features",
      "features": ["youtube-player-api"]
    },
    {
      "phase": 1,
      "name": "Minimal UI Shell",
      "description": "Dropdown container and active tools area - no state system yet",
      "features": ["video-tools-ui"]
    },
    {
      "phase": 2,
      "name": "SponsorBlock",
      "description": "Enabled by default in manual mode. No backend needed. Validates skip pattern before investing in silence backend.",
      "features": ["sponsor-skip"]
    },
    {
      "phase": 3,
      "name": "Silence Skipper",
      "description": "Most complex feature. Backend processes audio, frontend skips/speeds through silence.",
      "features": ["silence-skipper"]
    },
    {
      "phase": 4,
      "name": "Copy Transcript",
      "description": "Simple addition to existing backend",
      "features": ["copy-transcript"]
    }
  ],
  "features": [
    {
      "id": "svelte5-upgrade",
      "name": "Svelte 5 Upgrade",
      "phase": -1,
      "priority": "P0",
      "description": "Upgrade from Svelte 4 to Svelte 5 for modern reactivity patterns",
      "implementation": {
        "dependencies_to_update": ["svelte", "@sveltejs/kit", "svelte-check"],
        "verification": ["pnpm check", "test existing pages"],
        "notes": "Svelte 5 is backwards compatible with Svelte 4 syntax. New components use runes."
      },
      "acceptance_criteria": [
        "Svelte 5 installed and working",
        "Existing pages (home, video, shorts) still function",
        "No type errors from svelte-check"
      ]
    },
    {
      "id": "youtube-player-api",
      "name": "YouTube IFrame Player API Migration",
      "phase": 0,
      "priority": "P0",
      "description": "Replace static iframe with YouTube IFrame Player API to enable programmatic control",
      "rationale": "Required foundation for silence skipper, sponsor skip, and timestamp-aware features",
      "implementation": {
        "component": "src/lib/components/YouTubePlayer.svelte",
        "store": "src/lib/stores/playerStore.ts",
        "api_script": "https://www.youtube.com/iframe_api",
        "time_polling": "100ms interval when PLAYING, stop on pause/end/buffer",
        "events": ["onReady", "onStateChange"],
        "player_vars": {
          "autoplay": 0,
          "modestbranding": 1,
          "rel": 0
        },
        "store_state": {
          "currentTime": "number (seconds)",
          "duration": "number (seconds)",
          "playbackRate": "number",
          "playerState": "unstarted | ended | playing | paused | buffering | cued"
        },
        "safety": "Guard all player method calls: if (!player || typeof player.method !== 'function') return"
      },
      "acceptance_criteria": [
        "Player loads via IFrame API instead of raw iframe",
        "Can programmatically: play, pause, seekTo, getCurrentTime, setPlaybackRate, getPlaybackRate",
        "Player state accessible via Svelte store",
        "100ms time polling when playing",
        "No visual regression from current embed"
      ]
    },
    {
      "id": "video-tools-ui",
      "name": "Minimal Video Tools UI Shell",
      "phase": 1,
      "priority": "P0",
      "description": "Dropdown container and active tools area. Features add their own UI.",
      "design": {
        "dropdown": {
          "trigger": "'▸ video tools' text link",
          "expanded": "'▾ video tools'",
          "collapsed_by_default": true,
          "content": "Empty container - features add their own toggles"
        },
        "active_tools_area": {
          "location": "Below video, next to 'about' link",
          "shows": "Active tool UI components",
          "on_first_load": "Empty (all tools inactive except SponsorBlock)"
        },
        "url_params": {
          "read": "?tools= on page load",
          "write": "updateToolsParam(toolName, active)",
          "format": "?tools=silence",
          "note": "Sponsors enabled by default, no URL param needed"
        }
      },
      "acceptance_criteria": [
        "Dropdown expands/collapses on click",
        "Active tools area exists for features to populate",
        "URL param helpers work correctly",
        "Minimal styling matching existing emerald aesthetic"
      ]
    },
    {
      "id": "sponsor-skip",
      "name": "Skip Sponsors (SponsorBlock)",
      "phase": 2,
      "priority": "P1",
      "description": "Integrate SponsorBlock API to skip sponsor segments. Enabled by default in manual mode. No backend needed.",
      "components": {
        "main": "src/lib/components/SponsorSkip.svelte",
        "active_ui": "src/lib/components/SponsorSkipActive.svelte",
        "overlay_button": "src/lib/components/SponsorSkipButton.svelte",
        "settings": "src/lib/components/SponsorSettings.svelte",
        "types": "src/lib/types/sponsorBlock.ts"
      },
      "api": {
        "url": "https://sponsor.ajay.app/api/skipSegments?videoID={videoId}",
        "response_format": "[{segment: [start, end], category: string, UUID: string}]",
        "404_means": "No segments found (not an error)"
      },
      "categories": {
        "all": ["sponsor", "selfpromo", "interaction", "intro", "outro", "preview", "music_offtopic", "filler"],
        "default_enabled": ["sponsor", "selfpromo"]
      },
      "settings": {
        "localStorage_key": "yt-embed-sponsor-settings",
        "schema": {
          "mode": "auto | manual (default: manual)",
          "skipCategories": ["sponsor", "selfpromo"]
        }
      },
      "ui": {
        "dropdown": "Toggle 'Skip sponsors' (on by default) + gear icon for settings",
        "settings_popover": "Mode toggle (Auto-skip | Show button) + category checkboxes",
        "top_level_when_active_auto_mode": "Label 'SponsorBlock ✓ (N segments)' + click to disable",
        "overlay_button_manual_mode": {
          "position": "Bottom-right of player, above YouTube controls",
          "visibility": "Only when currentTime is within a sponsor segment",
          "content": "'Skip sponsor →' with category label",
          "style": "Semi-transparent background, fades in/out"
        }
      },
      "states": {
        "default": "Enabled, manual mode (button appears only when in sponsor segment)",
        "off": "User explicitly disabled in dropdown",
        "loading": "'Skip sponsors ...' in dropdown",
        "ready_auto": "Top-level 'SponsorBlock ✓ (N)' indicator",
        "ready_manual": "Nothing until sponsor segment, then overlay button",
        "ready_no_segments": "'Skip sponsors (none found)' in dropdown",
        "error": "'Skip sponsors ⚠' with tooltip"
      },
      "acceptance_criteria": [
        "Segments fetched via TanStack Query on page load (enabled by default)",
        "Skip logic triggers on playerStore time updates",
        "Auto mode: seeks past segment immediately",
        "Manual mode: shows overlay button, user clicks to skip",
        "Category settings saved to localStorage",
        "Only skips segments matching enabled categories",
        "Handles 404 (no segments) gracefully"
      ]
    },
    {
      "id": "silence-skipper",
      "name": "Silence Skipper",
      "phase": 3,
      "priority": "P1",
      "description": "Automatically skip or speed through silent segments with user-configurable settings",
      "components": {
        "backend": {
          "location": "backend/silence-service/",
          "framework": "Python FastAPI",
          "deployment": "Railway.app with volume mount for SQLite",
          "files": ["main.py", "silence.py", "queue.py", "db.py", "requirements.txt", "Dockerfile", "railway.toml"]
        },
        "frontend": {
          "main": "src/lib/components/SilenceSkipper.svelte",
          "active_ui": "src/lib/components/SilenceSkipperActive.svelte",
          "types": "src/lib/types/silence.ts"
        }
      },
      "backend_spec": {
        "endpoints": {
          "submit": {
            "method": "POST",
            "path": "/silence/request",
            "params": {
              "v": "videoId",
              "duration": "video duration in seconds (from player API onReady)"
            },
            "rate_limit": "5 new submissions per IP per hour (cached hits don't count)"
          },
          "status": {
            "method": "GET",
            "path": "/silence/status",
            "params": { "v": "videoId" }
          },
          "health": {
            "method": "GET",
            "path": "/health"
          }
        },
        "database": {
          "type": "SQLite with WAL mode",
          "path": "/data/silence.db",
          "tables": ["silence_cache", "queue", "rate_limits"]
        },
        "cache": {
          "strategy": "Indefinite cache, keyed by video_id",
          "invalidation": "Re-process if request duration != cached duration (catches video edits)",
          "no_ttl": true
        },
        "queue": {
          "concurrency": "1 video at a time (avoid IP ban)",
          "max_length": 50,
          "polling_interval": "2 seconds",
          "timeout_per_video": "5 minutes",
          "crash_recovery": "Reset 'processing' jobs to 'queued' on startup"
        },
        "silence_detection": {
          "library": "pydub.silence.detect_silence",
          "audio_format": "worstaudio/worst via yt-dlp",
          "threshold": "-40dB",
          "min_chunk": "100ms (frontend filters further)",
          "seek_step": "10ms"
        },
        "limits": {
          "max_video_duration": "12 hours"
        },
        "response_format": {
          "cached": "{ status: 'cached', segments: [...], duration_sec }",
          "queued": "{ status: 'queued', position: N }",
          "processing": "{ status: 'processing' }",
          "completed": "{ status: 'completed', segments: [...], duration_sec }",
          "failed": "{ status: 'failed', error: '...' }"
        },
        "errors": ["invalid_video_id", "video_unavailable", "age_restricted", "video_too_long", "download_failed", "rate_limited", "queue_full"]
      },
      "frontend_spec": {
        "important": "Wait for player onReady before submitting - need duration from player API",
        "settings": {
          "localStorage_key": "yt-embed-silence-settings",
          "schema": {
            "mode": { "type": "string", "options": ["skip", "speed"], "default": "skip" },
            "minSkipMs": { "type": "number", "default": 500, "description": "Minimum silence duration to act on" },
            "timeBeforeSkipping": { "type": "number", "default": 0, "description": "Wait this long into silence before skipping" },
            "timeAfterSkipping": { "type": "number", "default": 100, "description": "Resume this early before silence ends" }
          }
        },
        "skip_logic": {
          "mode_skip": "Seek to end of silence segment",
          "mode_speed": "Set playback rate to 2x during silence, restore on exit",
          "speed_reset_on": ["pause", "seek", "tool disabled", "mode switched", "component destroyed"]
        },
        "ui": {
          "dropdown": "Simple on/off toggle: 'Skip silence'",
          "top_level_when_active": [
            "Mode toggle: Skip | 2x speed",
            "Min skip slider (100ms - 2000ms)",
            "Time before/after inputs (0ms - 500ms)",
            "Time saved display: '32:15 → 28:42 (-3:33)'",
            "Toggle off button"
          ]
        },
        "states": {
          "off": "Toggle shows 'Skip silence'",
          "queued": "'Skip silence (queue: #N)'",
          "processing": "'Skip silence (analyzing...)'",
          "ready": "'Skip silence ✓'",
          "error": "'Skip silence ⚠' with retry button"
        }
      },
      "acceptance_criteria": [
        "Backend detects all silences ≥100ms, returns full list in one response",
        "Frontend filters segments by minSkipMs setting",
        "Frontend applies timeBeforeSkipping/timeAfterSkipping margins",
        "Speed mode correctly enters/exits 2x speed on silence boundaries",
        "Speed mode resets to normal rate on pause/seek",
        "Settings saved to localStorage",
        "Cache invalidates when video duration changes",
        "URL param 'silence' activates tool on page load"
      ]
    },
    {
      "id": "copy-transcript",
      "name": "Copy Transcript",
      "phase": 4,
      "priority": "P1",
      "description": "One-click copy video transcript to clipboard",
      "components": {
        "backend": {
          "location": "backend/silence-service/ (same service)",
          "endpoint": "GET /transcript?v={videoId}&timestamps={true|false}",
          "library": "youtube-transcript-api",
          "cache": "SQLite, 7 day TTL"
        },
        "frontend": {
          "component": "src/lib/components/CopyTranscript.svelte"
        }
      },
      "formats": {
        "plain": "Text joined with spaces",
        "timestamps": "[0:00] First line\\n[0:05] Second line"
      },
      "ui": {
        "dropdown": "Submenu 'Copy transcript ▸' with 'Plain text' / 'With timestamps'",
        "top_level": "Not shown (action-only, no persistent state)",
        "states": {
          "default": "Show submenu options",
          "loading": "'Copying...'",
          "success": "'Copied!' (brief inline feedback)",
          "error": "'No transcript available'"
        }
      },
      "acceptance_criteria": [
        "Transcript fetched on demand",
        "Two copy options: plain and timestamped",
        "Direct clipboard copy, no preview",
        "Clear feedback on success/failure",
        "Graceful error when no transcript (404)"
      ]
    }
  ],
  "deferred_features": [
    {
      "id": "shazam-tool",
      "name": "Shazam/Song Detection",
      "reason": "API costs too high ($2/1000 for AudD). Research alternatives."
    }
  ],
  "technical_requirements": {
    "frontend": {
      "framework": "SvelteKit with Svelte 5",
      "player": "YouTube IFrame Player API",
      "state": {
        "player": "Svelte store (currentTime, duration, playbackRate, playerState)",
        "tools": "Per-feature state, no shared toolsStore",
        "persistence": "localStorage for settings (per-feature keys), URL params for active state"
      },
      "data_fetching": "TanStack Query (@tanstack/svelte-query)",
      "analytics": "sendAnalyticsEvent() via existing pattern",
      "env_vars": {
        "VITE_SILENCE_SERVICE_URL": "Backend URL (public, not secret)"
      }
    },
    "backend": {
      "deployment": "Railway.app with volume mount",
      "framework": "Python FastAPI",
      "database": "SQLite with WAL mode at /data/silence.db",
      "cors": "Allow * (or restrict to yt.ttools.io)",
      "dependencies": ["fastapi", "uvicorn", "yt-dlp", "pydub", "python-multipart", "youtube-transcript-api"]
    }
  },
  "localStorage_keys": {
    "yt-embed-sponsor-settings": {
      "mode": "manual",
      "skipCategories": ["sponsor", "selfpromo"]
    },
    "yt-embed-silence-settings": {
      "mode": "skip",
      "minSkipMs": 500,
      "timeBeforeSkipping": 0,
      "timeAfterSkipping": 100
    }
  },
  "url_params": {
    "tools": {
      "description": "Comma-separated list of active tools (sponsors excluded - enabled by default)",
      "example": "?tools=silence",
      "valid_values": ["silence"]
    }
  },
  "analytics_events": {
    "toolEnabled": { "event": "toolEnabled", "details": "toolName (sponsors only when re-enabled after user disabled)" },
    "toolDisabled": { "event": "toolDisabled", "details": "toolName" },
    "transcriptCopied": { "event": "transcriptCopied", "details": "'plain' | 'withTimestamps'" },
    "silenceSkipped": { "event": "silenceSkipped", "debounce": "10s" },
    "sponsorSkipped": { "event": "sponsorSkipped", "details": "'auto' | 'manual'", "debounce": "10s for auto" },
    "silenceQueueJoined": { "event": "silenceQueueJoined" }
  },
  "error_handling": {
    "silence_service_down": "Toggle disabled, 'Service unavailable' tooltip",
    "silence_processing_failed": "Error state with retry button",
    "silence_queue_full": "'Queue full, try later'",
    "age_restricted_video": "'Can't process age-restricted videos'",
    "sponsorblock_api_down": "Toggle disabled, graceful message",
    "sponsorblock_404": "'No sponsors found' (not error)",
    "transcript_unavailable": "'No transcript for this video'",
    "clipboard_api_fails": "'Couldn't copy, try again'"
  },
  "file_structure": {
    "frontend": [
      "src/lib/components/YouTubePlayer.svelte",
      "src/lib/components/VideoTools.svelte",
      "src/lib/components/SponsorSkip.svelte",
      "src/lib/components/SponsorSkipActive.svelte",
      "src/lib/components/SponsorSkipButton.svelte",
      "src/lib/components/SponsorSettings.svelte",
      "src/lib/components/SilenceSkipper.svelte",
      "src/lib/components/SilenceSkipperActive.svelte",
      "src/lib/components/CopyTranscript.svelte",
      "src/lib/stores/playerStore.ts",
      "src/lib/types/sponsorBlock.ts",
      "src/lib/types/silence.ts",
      "src/lib/config.ts"
    ],
    "backend": [
      "backend/silence-service/main.py",
      "backend/silence-service/silence.py",
      "backend/silence-service/transcript.py",
      "backend/silence-service/queue.py",
      "backend/silence-service/db.py",
      "backend/silence-service/requirements.txt",
      "backend/silence-service/Dockerfile",
      "backend/silence-service/railway.toml"
    ]
  },
  "notes": {
    "multiple_tools_active": "When both SponsorSkip and SilenceSkipper are enabled, both may try to seek. Sponsor segments are larger, so sponsor skip effectively takes precedence. Speed mode state resets correctly on any seek.",
    "legal": "Audio processed server-side and deleted immediately. No user downloads. Will comply with any YouTube cease letter."
  }
}
